#pragma once
#include "bitboard.hpp"
#include "core.hpp"
#define MAGICS_ARRAY_SIZE 200000

typedef std::uint64_t Bitboard;
inline Bitboard getMagicIndex(Bitboard board, Bitboard magic, uint8_t shift) {
    return (board * magic) >> shift;
}

class Magic {
  public:
    Bitboard *attacks;
    Bitboard magic;
    Bitboard mask;
    uint8_t shift;
    inline Bitboard getMagicIndex(Bitboard board) {
        return (board * magic) >> shift;
    }
    inline Bitboard getAttack(Bitboard occupation) {
        return attacks[getMagicIndex(occupation & mask)];
    }
};

extern std::array<Bitboard, MAGICS_ARRAY_SIZE> magics;
extern std::array<Magic, Square::SQUARE_COUNT> rookMagics;
extern std::array<Magic, Square::SQUARE_COUNT> bishopMagics;
extern std::array<std::array<Bitboard, Square::SQUARE_COUNT>,
                  RayDirection::RAY_COUNT>
    rays;
extern std::array<Bitboard, Square::SQUARE_COUNT> rankAttacks;
extern std::array<Bitboard, Square::SQUARE_COUNT> fileAttacks;
extern std::array<std::array<Bitboard, Square::SQUARE_COUNT>, 2> pawnAttacks;
extern std::array<Bitboard, Square::SQUARE_COUNT> knightAttacks;
extern std::array<Bitboard, Square::SQUARE_COUNT> kingAttacks;
extern std::array<Bitboard, Square::SQUARE_COUNT> bishopMasks;
extern std::array<Bitboard, Square::SQUARE_COUNT> rookMasks;
extern std::array<Bitboard, Square::SQUARE_COUNT> queenMasks;
extern std::array<std::array<Bitboard, Square::SQUARE_COUNT>, 2> pawnPushes;
extern std::array<std::array<Bitboard, Square::SQUARE_COUNT>, 2>
    pawnDoublePushes;
extern std::array<Bitboard, Square::SQUARE_COUNT> maskedSquare;
extern std::array<Bitboard, Square::SQUARE_COUNT> unmaskedSquare;

void initGlobals();

void initMasks();
void initMagics();
void initRayAttacks();

Magic initMagicSquare(SquareIndex index, bool bishop, uint64_t *magicIndex);

Bitboard getRayAttacks(Bitboard occupied, RayDirection direction,
                       SquareIndex square);

// Line attacks
Bitboard getDiagonalMask(SquareIndex index);
Bitboard getDiagonal2Mask(SquareIndex index);
Bitboard getRankMask(SquareIndex index);
Bitboard getFileMask(SquareIndex index);

// Piece attacks
Bitboard getQueenMask(SquareIndex index);
Bitboard getRookMask(SquareIndex index);
Bitboard getBishopMask(SquareIndex index);

Bitboard getKnightAttacks(Bitboard board);
Bitboard getKingAttacks(Bitboard board);
Bitboard getBishopAttacks(SquareIndex index, Bitboard occupancy);
Bitboard getRookAttacks(SquareIndex index, Bitboard occupancy);

constexpr std::array<Bitboard, Square::SQUARE_COUNT> bishopMagicNumbers = {
    297457482031202818ULL,   1423718041586254880ULL,  4612834200762974208ULL,
    1527041337516359808ULL,  299344188145698ULL,      9243675691856363650ULL,
    666815356555232256ULL,   10754667412785726720ULL, 396334498041630787ULL,
    576462959952400898ULL,   54087185661561984ULL,    2350888918288957440ULL,
    36029966323810304ULL,    4611686611680247872ULL,  2314851326252550144ULL,
    27022184162001476ULL,    1212176402970312972ULL,  2537690285244928ULL,
    2340396466438160ULL,     4644508947989768ULL,     3604006710175467586ULL,
    17169982186095136ULL,    281552306045440ULL,      2322789185097764ULL,
    5103934052516352ULL,     18304704023897104ULL,    72215923884556416ULL,
    23089744217379072ULL,    20411335544152080ULL,    13853215394600456192ULL,
    4612816385104759813ULL,  517984601852087360ULL,   9516123644548614144ULL,
    10381361538448491008ULL, 1126209211663888ULL,     4611811364900962432ULL,
    594485050712526912ULL,   4611968635903213632ULL,  9944572508438597760ULL,
    11533456970653663568ULL, 144401072373383296ULL,   1200958822440992ULL,
    435161414118672384ULL,   275150537218ULL,         1175448337558569232ULL,
    9008324605445634ULL,     4613940859145061440ULL,  9248142935969497604ULL,
    9241527825826061328ULL,  5262504629027480704ULL,  283602322432ULL,
    52778773004294ULL,       1161937568708198404ULL,  648629467916404736ULL,
    18067488617074688ULL,    9245892818134663168ULL,  9872453925991490048ULL,
    108093061158404608ULL,   577023706619057668ULL,   9223407272800682497ULL,
    9017096201701504ULL,     145245658143004160ULL,   2454753201996955736ULL,
    306253579411275793ULL};

constexpr std::array<Bitboard, Square::SQUARE_COUNT> rookMagicNumbers = {
    180146184118141000ULL,
    4513082931953666ULL,
    3746995448927224064ULL,
    5333396655343403264ULL,
    20266198323232896ULL,
    9529619010539241472ULL,
    4616541462446735410ULL,
    288371254451273732ULL,
    35184640524288ULL,
    137473819012ULL,
    9010499937141632ULL,
    4785350018860192ULL,
    2199027516578ULL,
    10403315968157156354ULL,
    1302785987448832ULL,
    9799841860198335748ULL,
    36033306734631460ULL,
    90073366936947200ULL,
    306248081786011905ULL,
    2018179981061915184ULL,
    41096480505893376ULL,
    78816304093466624ULL,
    579099599537438976ULL,
    144150406807683088ULL,
    4657285005457031168ULL,
    9017112328718336ULL,
    504473939326747648ULL,
    11583260440754422784ULL,
    108651618987147649ULL,
    1459166313628303392ULL,
    2260596318032516ULL,
    72057613644726272ULL,
    2341871806534648064ULL,
    1152921504612090945ULL,
    4505936358016404ULL,
    37160195582853122ULL,
    2252491706599426ULL,
    4755801498569409024ULL,
    9511602413308477812ULL,
    9223372037392171584ULL,
    9232942186062948614ULL,
    290587763442483200ULL,
    12589056ULL,
    4503599628567104ULL,
    4764809024234455424ULL,
    729583209428287496ULL,
    281479288498192ULL,
    211260851621892ULL,
    14987979834767442216ULL,
    2396943938490432ULL,
    144343886495219968ULL,
    4538835572621320ULL,
    14141304479233937920ULL,
    9007199254807104ULL,
    2306757813726089252ULL,
    19140298433106200ULL,
    9228161784517492739ULL,
    585542718386901056ULL,
    9511602417305649284ULL,
    9223385230994872323ULL,
    8724676609ULL,
    65302211844898818ULL,
    562967133290497ULL,
    10160122958371356680ULL};
